<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üèãÔ∏è –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫</title>
    <!-- Telegram Web App SDK -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'tg-bg': 'var(--tg-theme-bg-color)',
                        'tg-text': 'var(--tg-theme-text-color)',
                        'tg-hint': 'var(--tg-theme-hint-color)',
                        'tg-button': 'var(--tg-theme-button-color)',
                        'tg-button-text': 'var(--tg-theme-button-text-color)',
                        'tg-secondary': 'var(--tg-theme-secondary-bg-color)',
                    }
                }
            }
        }
    </script>
    <style>
        :root {
            --tg-theme-bg-color: #ffffff;
            --tg-theme-text-color: #000000;
            --tg-theme-hint-color: #999999;
            --tg-theme-link-color: #2481cc;
            --tg-theme-button-color: #2481cc;
            --tg-theme-button-text-color: #ffffff;
            --tg-theme-secondary-bg-color: #f1f1f1;
        }

        * {
            -webkit-tap-highlight-color: transparent;
        }

        body {
            background-color: var(--tg-theme-bg-color);
            color: var(--tg-theme-text-color);
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
        }

        /* –°—Ç–∏–ª–∏ –¥–ª—è –ø–æ–ª–µ–π –≤–≤–æ–¥–∞ –≤ —Ç–µ–º–Ω–æ–π —Ç–µ–º–µ */
        input, textarea, select {
            background-color: var(--tg-theme-secondary-bg-color) !important;
            color: var(--tg-theme-text-color) !important;
            border-color: var(--tg-theme-hint-color) !important;
        }

        input::placeholder, textarea::placeholder {
            color: var(--tg-theme-hint-color) !important;
        }

        .tg-button {
            background-color: var(--tg-theme-button-color);
            color: var(--tg-theme-button-text-color);
        }

        .tg-button:hover {
            opacity: 0.9;
        }

        .tg-secondary-bg {
            background-color: var(--tg-theme-secondary-bg-color);
        }

        .border-tg-hint {
            border-color: var(--tg-theme-hint-color);
        }

        .text-tg-hint {
            color: var(--tg-theme-hint-color);
        }

        .fade-in {
            animation: fadeIn 0.3s ease-in-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* –ö–∞—Å—Ç–æ–º–Ω—ã–π —Å–∫—Ä–æ–ª–ª–±–∞—Ä */
        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: var(--tg-theme-secondary-bg-color);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--tg-theme-button-color);
            border-radius: 3px;
        }

        /* –°—Ç–∏–ª–∏ –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤ */
        .selected {
            border-color: var(--tg-theme-button-color) !important;
            background-color: rgba(36, 129, 204, 0.1) !important;
        }
    </style>
</head>
<body class="min-h-screen">
    <div id="app" class="container mx-auto px-4 pb-20 pt-4"></div>

    <script>
        class FitnessApp extends HTMLElement {
            constructor() {
                super();
                this.tg = window.Telegram?.WebApp;
                this.sessionId = null;
                this.currentStep = 1;
                this.totalSteps = 5;
                this.userData = {};
                this.isLoading = false;
                this.telegramUser = null;
                this.programContent = null;

                this.initTelegram();
            }

            async connectedCallback() {
                this.render();
                await this.startSession();
            }

            initTelegram() {
                if (this.tg) {
                    // –†–∞–∑–≤–µ—Ä–Ω—É—Ç—å –Ω–∞ –≤–µ—Å—å —ç–∫—Ä–∞–Ω
                    this.tg.expand();

                    // –ü–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                    this.telegramUser = this.tg.initDataUnsafe?.user;

                    // –ü—Ä–∏–º–µ–Ω–∏—Ç—å —Ç–µ–º—É Telegram
                    this.applyTelegramTheme();

                    // –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –∫–Ω–æ–ø–∫—É "–ù–∞–∑–∞–¥"
                    this.setupBackButton();

                    // –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –≥–ª–∞–≤–Ω—É—é –∫–Ω–æ–ø–∫—É
                    this.setupMainButton();

                    console.log('Telegram Web App initialized:', {
                        user: this.telegramUser,
                        theme: this.tg.themeParams
                    });
                }
            }

            applyTelegramTheme() {
                if (this.tg && this.tg.themeParams) {
                    // –ü—Ä–∏–º–µ–Ω—è–µ–º —Ü–≤–µ—Ç–∞ Telegram
                    const root = document.documentElement;
                    root.style.setProperty('--tg-theme-bg-color', this.tg.themeParams.bg_color || '#ffffff');
                    root.style.setProperty('--tg-theme-text-color', this.tg.themeParams.text_color || '#000000');
                    root.style.setProperty('--tg-theme-hint-color', this.tg.themeParams.hint_color || '#999999');
                    root.style.setProperty('--tg-theme-button-color', this.tg.themeParams.button_color || '#2481cc');
                    root.style.setProperty('--tg-theme-button-text-color', this.tg.themeParams.button_text_color || '#ffffff');
                    root.style.setProperty('--tg-theme-secondary-bg-color', this.tg.themeParams.secondary_bg_color || '#f1f1f1');
                }
            }

            setupBackButton() {
                if (this.tg) {
                    this.tg.BackButton.show();
                    this.tg.BackButton.onClick(() => {
                        if (this.currentStep > 1) {
                            this.prevStep();
                        } else {
                            this.tg.close();
                        }
                    });
                }
            }

            setupMainButton() {
                if (this.tg) {
                    this.tg.MainButton.hide();
                    this.tg.MainButton.setParams({
                        text: '–î–ê–õ–ï–ï',
                        color: this.tg.themeParams.button_color || '#2481cc',
                        text_color: this.tg.themeParams.button_text_color || '#ffffff'
                    });
                    this.tg.MainButton.onClick(() => this.nextStep());
                }
            }

            updateMainButton() {
                if (!this.tg) return;

                const isValid = this.validateCurrentStep();
                if (isValid && this.currentStep <= this.totalSteps) {
                    this.tg.MainButton.setText(this.currentStep === this.totalSteps ? '–°–ì–ï–ù–ï–†–ò–†–û–í–ê–¢–¨' : '–î–ê–õ–ï–ï');
                    this.tg.MainButton.show();
                } else {
                    this.tg.MainButton.hide();
                }
            }

            async startSession() {
                try {
                    const user_id = this.tg?.initDataUnsafe?.user?.id;

                    const response = await fetch('/api/start_session', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            user_id: user_id ? user_id.toString() : null
                        })
                    });

                    const data = await response.json();
                    this.sessionId = data.profile_id;  // –°–æ—Ö—Ä–∞–Ω—è–µ–º profile_id –∫–∞–∫ sessionId
                    this.profileId = data.profile_id;
                    console.log('Session started:', data);
                } catch (error) {
                    console.error('Failed to start session:', error);
                }
            }


            async saveStep(stepData) {
                if (!this.sessionId) {
                    this.showError('–°–µ—Å—Å–∏—è –Ω–µ –Ω–∞—á–∞—Ç–∞');
                    return null;
                }

                this.isLoading = true;
                this.render();

                try {
                    const response = await fetch(`/api/step/${this.currentStep}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            profile_id: this.profileId,  // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º profile_id
                            session_id: this.profileId,  // –ò session_id –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
                            ...stepData
                        })
                    });


                    if (!response.ok) {
                        const errorText = await response.text();
                        throw new Error(`HTTP error! status: ${response.status}, ${errorText}`);
                    }

                    return await response.json();
                } catch (error) {
                    console.error('Failed to save step:', error);
                    this.showError(`–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —à–∞–≥ ${stepNumber}: ${error.message}`);
                    return null;
                } finally {
                    this.isLoading = false;
                }
            }

            async generateProgram() {
                if (!this.sessionId) {
                    this.showError('–°–µ—Å—Å–∏—è –Ω–µ –Ω–∞—á–∞—Ç–∞');
                    return null;
                }

                this.isLoading = true;
                this.render();

                try {
                    const response = await fetch('/api/generate_program', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            session_id: this.sessionId
                        })
                    });

                    if (!response.ok) {
                        const errorText = await response.text();
                        throw new Error(`HTTP error! status: ${response.status}, ${errorText}`);
                    }

                    const result = await response.json();
                    return result;
                } catch (error) {
                    console.error('Failed to generate program:', error);
                    this.showError(`–ù–µ —É–¥–∞–ª–æ—Å—å —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ–≥—Ä–∞–º–º—É: ${error.message}`);
                    return null;
                } finally {
                    this.isLoading = false;
                }
            }

            render() {
                this.innerHTML = `
                    <div class="max-w-lg mx-auto fade-in">
                        <div class="mb-6">
                            <h1 class="text-2xl font-bold text-center mb-2 text-tg-text">
                                üèãÔ∏è –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫
                            </h1>
                            ${this.telegramUser ? `
                                <p class="text-center text-sm text-tg-hint">
                                    –ü—Ä–∏–≤–µ—Ç, ${this.telegramUser.first_name}!
                                </p>
                            ` : ''}

                            <div class="mt-4">
                                <div class="flex justify-between text-sm mb-1">
                                    <span class="text-tg-text">–ü—Ä–æ–≥—Ä–µ—Å—Å</span>
                                    <span class="text-tg-text">–®–∞–≥ ${this.currentStep} –∏–∑ ${this.totalSteps}</span>
                                </div>
                                <div class="w-full bg-tg-secondary rounded-full h-2">
                                    <div class="tg-button h-2 rounded-full transition-all duration-300"
                                         style="width: ${(this.currentStep / this.totalSteps) * 100}%">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="bg-tg-bg rounded-xl shadow-sm border border-tg-hint p-4 mb-4">
                            ${this.renderStep()}
                        </div>

                        <div class="text-center text-xs text-tg-hint mt-2">
                            –®–∞–≥ ${this.currentStep}: ${this.getStepDescription()}
                        </div>

                        ${this.isLoading ? this.renderLoader() : ''}
                    </div>
                `;

                this.updateMainButton();
                this.attachEventListeners();
            }

            renderLoader() {
                return `
                    <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                        <div class="bg-tg-bg p-6 rounded-xl border border-tg-hint">
                            <div class="flex items-center space-x-3">
                                <div class="animate-spin rounded-full h-6 w-6 border-b-2 tg-button"></div>
                                <span class="text-tg-text">${this.currentStep === 6 ? '–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ø—Ä–æ–≥—Ä–∞–º–º—ã...' : '–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...'}</span>
                            </div>
                        </div>
                    </div>
                `;
            }

            getStepDescription() {
                const descriptions = {
                    1: '–û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è',
                    2: '–¶–µ–ª—å —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫',
                    3: '–û–ø—ã—Ç –∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã',
                    4: '–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –∏ —Å—Ç–∏–ª—å',
                    5: '–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –∏ –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏—è',
                    6: '–†–µ–∑—É–ª—å—Ç–∞—Ç'
                };
                return descriptions[this.currentStep] || '';
            }

            renderStep() {
                const steps = {
                    1: this.renderStep1(),
                    2: this.renderStep2(),
                    3: this.renderStep3(),
                    4: this.renderStep4(),
                    5: this.renderStep5(),
                    6: this.renderResult()
                };
                return steps[this.currentStep] || this.renderStep1();
            }

            renderStep1() {
                return `
                    <div class="fade-in">
                        <h2 class="text-lg font-semibold mb-4 text-tg-text">1. –†–∞—Å—Å–∫–∞–∂–∏—Ç–µ –æ —Å–µ–±–µ</h2>

                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium mb-2 text-tg-text">–ü–æ–ª</label>
                                <div class="flex space-x-3">
                                    <button type="button"
                                            class="flex-1 py-3 text-center border rounded-lg ${this.userData.gender === 'male' ? 'selected border-tg-button' : 'border-tg-hint'}"
                                            onclick="app.selectGender('male')">
                                        <span class="${this.userData.gender === 'male' ? 'text-tg-button' : 'text-tg-text'}">–ú—É–∂—Å–∫–æ–π</span>
                                    </button>
                                    <button type="button"
                                            class="flex-1 py-3 text-center border rounded-lg ${this.userData.gender === 'female' ? 'selected border-tg-button' : 'border-tg-hint'}"
                                            onclick="app.selectGender('female')">
                                        <span class="${this.userData.gender === 'female' ? 'text-tg-button' : 'text-tg-text'}">–ñ–µ–Ω—Å–∫–∏–π</span>
                                    </button>
                                </div>
                            </div>

                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium mb-2 text-tg-text">–í–æ–∑—Ä–∞—Å—Ç</label>
                                    <input type="number" id="age"
                                           class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-tg-button focus:border-transparent"
                                           min="10" max="100"
                                           value="${this.userData.age || ''}"
                                           placeholder="–õ–µ—Ç"
                                           onchange="app.updateField('age', this.value)">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-2 text-tg-text">–†–æ—Å—Ç</label>
                                    <input type="number" id="height"
                                           class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-tg-button focus:border-transparent"
                                           min="100" max="250"
                                           value="${this.userData.height || ''}"
                                           placeholder="—Å–º"
                                           onchange="app.updateField('height', this.value)">
                                </div>
                            </div>

                            <div>
                                <label class="block text-sm font-medium mb-2 text-tg-text">–í–µ—Å</label>
                                <input type="number" id="weight"
                                       class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-tg-button focus:border-transparent"
                                       min="30" max="200"
                                       value="${this.userData.weight || ''}"
                                       placeholder="–∫–≥"
                                       onchange="app.updateField('weight', this.value)">
                            </div>
                        </div>
                    </div>
                `;
            }

            renderStep2() {
                const goals = [
                    { value: 'bench_100kg', text: '–ñ–∏–º –ª–µ–∂–∞ 100 –∫–≥', desc: '–†–∞–∑–≤–∏—Ç—å —Å–∏–ª—É –≥—Ä—É–¥–∏' },
                    { value: 'lose_7kg', text: '–ü–æ—Ö—É–¥–µ—Ç—å –Ω–∞ 7 –∫–≥', desc: '–°–±—Ä–æ—Å–∏—Ç—å –≤–µ—Å' },
                    { value: 'pullups_12', text: '–ü–æ–¥—Ç—è–≥–∏–≤–∞—Ç—å—Å—è 12 —Ä–∞–∑', desc: '–£–ª—É—á—à–∏—Ç—å –≤—ã–Ω–æ—Å–ª–∏–≤–æ—Å—Ç—å' },
                    { value: 'gain_4kg', text: '–ù–∞–±—Ä–∞—Ç—å 4 –∫–≥ –º—ã—à—Ü', desc: '–ù–∞–±—Ä–∞—Ç—å –º–∞—Å—Å—É' },
                    { value: 'custom', text: '–°–≤–æ—è —Ü–µ–ª—å', desc: '–û–ø–∏—à–∏—Ç–µ —Å–≤–æ—é' }
                ];

                return `
                    <div class="fade-in">
                        <h2 class="text-lg font-semibold mb-4 text-tg-text">2. –í—ã–±–µ—Ä–∏—Ç–µ —Ü–µ–ª—å</h2>

                        <div class="space-y-3 mb-6">
                            ${goals.map(goal => `
                                <button type="button"
                                        class="w-full text-left p-3 border rounded-lg ${this.userData.goal === goal.value ? 'selected border-tg-button' : 'border-tg-hint'}"
                                        onclick="app.selectGoal('${goal.value}')">
                                    <div class="font-medium ${this.userData.goal === goal.value ? 'text-tg-button' : 'text-tg-text'}">${goal.text}</div>
                                    <div class="text-sm text-tg-hint">${goal.desc}</div>
                                </button>
                            `).join('')}
                        </div>

                        ${this.userData.goal === 'custom' ? `
                            <div class="mb-4">
                                <label class="block text-sm font-medium mb-2 text-tg-text">–û–ø–∏—à–∏—Ç–µ –≤–∞—à—É —Ü–µ–ª—å</label>
                                <textarea id="custom-goal"
                                          class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-tg-button focus:border-transparent"
                                          rows="2"
                                          placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: —É–ª—É—á—à–∏—Ç—å –≤—ã–Ω–æ—Å–ª–∏–≤–æ—Å—Ç—å, –ø–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å—Å—è –∫ –º–∞—Ä–∞—Ñ–æ–Ω—É..."
                                          onchange="app.updateField('custom_goal', this.value)">${this.userData.custom_goal || ''}</textarea>
                            </div>
                        ` : ''}

                        <div>
                            <label class="block text-sm font-medium mb-2 text-tg-text">
                                –°—Ä–æ–∫ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è: <span id="months-value" class="text-tg-button">${this.userData.months || 3}</span> –º–µ—Å—è—Ü–µ–≤
                            </label>
                            <input type="range" id="months" min="1" max="12" step="1"
                                   class="w-full h-2 bg-tg-secondary rounded-lg appearance-none cursor-pointer"
                                   value="${this.userData.months || 3}">
                            <div class="flex justify-between text-xs text-tg-hint mt-1">
                                <span>1 –º–µ—Å—è—Ü</span>
                                <span>12 –º–µ—Å—è—Ü–µ–≤</span>
                            </div>
                        </div>
                    </div>
                `;
            }

            renderStep3() {
                const experiences = [
                    { value: 'currently', text: '–°–µ–π—á–∞—Å —Ç—Ä–µ–Ω–∏—Ä—É—é—Å—å' },
                    { value: 'lt_3_months', text: '–ú–µ–Ω–µ–µ 3 –º–µ—Å—è—Ü–µ–≤ –Ω–∞–∑–∞–¥' },
                    { value: '3_6_months', text: '3-6 –º–µ—Å—è—Ü–µ–≤ –Ω–∞–∑–∞–¥' },
                    { value: '6_12_months', text: '6-12 –º–µ—Å—è—Ü–µ–≤ –Ω–∞–∑–∞–¥' },
                    { value: 'gt_year', text: '–ë–æ–ª—å—à–µ –≥–æ–¥–∞ –Ω–∞–∑–∞–¥' }
                ];

                return `
                    <div class="fade-in">
                        <h2 class="text-lg font-semibold mb-4 text-tg-text">3. –û–ø—ã—Ç —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫</h2>

                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium mb-2 text-tg-text">–í–∞—à–∏ –ª—É—á—à–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã</label>
                                <textarea id="current-results"
                                          class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-tg-button focus:border-transparent"
                                          rows="3"
                                          placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –∂–∏–º –ª–µ–∂–∞ - 80–∫–≥, –ø—Ä–∏—Å–µ–¥ - 100–∫–≥, –ø–æ–¥—Ç—è–≥–∏–≤–∞–Ω–∏—è - 8 —Ä–∞–∑..."
                                          onchange="app.updateField('current_results', this.value)">${this.userData.current_results || ''}</textarea>
                            </div>

                            <div>
                                <label class="block text-sm font-medium mb-2 text-tg-text">–ö–æ–≥–¥–∞ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∞–ª–∏—Å—å –ø–æ—Å–ª–µ–¥–Ω–∏–π —Ä–∞–∑?</label>
                                <div class="space-y-2">
                                    ${experiences.map(exp => `
                                        <button type="button"
                                                class="w-full text-left p-3 border rounded-lg ${this.userData.last_trained === exp.value ? 'selected border-tg-button' : 'border-tg-hint'}"
                                                onclick="app.selectExperience('${exp.value}')">
                                            <span class="${this.userData.last_trained === exp.value ? 'text-tg-button' : 'text-tg-text'}">${exp.text}</span>
                                        </button>
                                    `).join('')}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }

            renderStep4() {
                const styles = [
                    { value: 'balanced', text: '–°–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π', desc: '–û–ø—Ç–∏–º–∞–ª—å–Ω—ã–π –±–∞–ª–∞–Ω—Å' },
                    { value: 'strength', text: '–°–∏–ª–æ–≤–æ–π', desc: '–ë–æ–ª—å—à–µ —Å–∏–ª—ã, –º–µ–Ω—å—à–µ –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏–π' },
                    { value: 'hypertrophy', text: '–ì–∏–ø–µ—Ä—Ç—Ä–æ—Ñ–∏—è/–í—ã–Ω–æ—Å–ª–∏–≤–æ—Å—Ç—å', desc: '–ë–æ–ª—å—à–µ –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏–π, —Ä–æ—Å—Ç –º—ã—à—Ü' }
                ];

                return `
                    <div class="fade-in">
                        <h2 class="text-lg font-semibold mb-4 text-tg-text">4. –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫</h2>

                        <div class="space-y-6">
                            <div>
                                <label class="block text-sm font-medium mb-2 text-tg-text">–°–∫–æ–ª—å–∫–æ —Ä–∞–∑ –≤ –Ω–µ–¥–µ–ª—é –º–æ–∂–µ—Ç–µ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∞—Ç—å—Å—è?</label>
                                <div class="grid grid-cols-7 gap-1">
                                    ${[1,2,3,4,5,6,7].map(num => `
                                        <button type="button"
                                                class="py-3 text-center border rounded-lg ${this.userData.workouts_per_week === num ? 'selected border-tg-button' : 'border-tg-hint'}"
                                                onclick="app.selectWorkoutsPerWeek(${num})">
                                            <span class="${this.userData.workouts_per_week === num ? 'text-tg-button' : 'text-tg-text'}">${num}</span>
                                        </button>
                                    `).join('')}
                                </div>
                            </div>

                            <div>
                                <label class="block text-sm font-medium mb-2 text-tg-text">–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –æ–¥–Ω–æ–π —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏</label>
                                <div class="grid grid-cols-3 gap-2">
                                    ${[30, 45, 60, 75, 90, 120].map(minutes => `
                                        <button type="button"
                                                class="py-3 text-center border rounded-lg ${this.userData.workout_duration === minutes ? 'selected border-tg-button' : 'border-tg-hint'}"
                                                onclick="app.selectWorkoutDuration(${minutes})">
                                            <span class="${this.userData.workout_duration === minutes ? 'text-tg-button' : 'text-tg-text'}">${minutes} –º–∏–Ω</span>
                                        </button>
                                    `).join('')}
                                </div>
                            </div>

                            <div>
                                <label class="block text-sm font-medium mb-2 text-tg-text">–ü—Ä–µ–¥–ø–æ—á–∏—Ç–∞–µ–º—ã–π —Å—Ç–∏–ª—å</label>
                                <div class="space-y-2">
                                    ${styles.map(style => `
                                        <button type="button"
                                                class="w-full text-left p-3 border rounded-lg ${this.userData.training_style === style.value ? 'selected border-tg-button' : 'border-tg-hint'}"
                                                onclick="app.selectTrainingStyle('${style.value}')">
                                            <div class="font-medium ${this.userData.training_style === style.value ? 'text-tg-button' : 'text-tg-text'}">${style.text}</div>
                                            <div class="text-sm text-tg-hint">${style.desc}</div>
                                        </button>
                                    `).join('')}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }

            renderStep5() {
                return `
                    <div class="fade-in">
                        <h2 class="text-lg font-semibold mb-4 text-tg-text">5. –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –∏ –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏—è</h2>

                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium mb-2 text-tg-text">–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –ø–æ –∑–¥–æ—Ä–æ–≤—å—é</label>
                                <textarea id="health-restrictions"
                                          class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-tg-button focus:border-transparent"
                                          rows="2"
                                          placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ø—Ä–æ–±–ª–µ–º—ã —Å –∫–æ–ª–µ–Ω—è–º–∏, –±–æ–ª—å –≤ —Å–ø–∏–Ω–µ... (–æ—Å—Ç–∞–≤—å—Ç–µ –ø—É—Å—Ç—ã–º, –µ—Å–ª–∏ –Ω–µ—Ç)"
                                          onchange="app.updateField('health_restrictions', this.value)">${this.userData.health_restrictions || ''}</textarea>
                                <p class="text-xs text-tg-hint mt-1">–ë—É–¥—É—Ç —Å—Ç—Ä–æ–≥–æ —É—á—Ç–µ–Ω—ã –≤ –ø—Ä–æ–≥—Ä–∞–º–º–µ</p>
                            </div>

                            <div>
                                <label class="block text-sm font-medium mb-2 text-tg-text">–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω—ã–µ –∑–æ–Ω—ã –∏ –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏—è</label>
                                <textarea id="preferences"
                                          class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-tg-button focus:border-transparent"
                                          rows="2"
                                          placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: —Ö–æ—á—É –±–æ–ª—å—à–µ –≤–Ω–∏–º–∞–Ω–∏—è –Ω–æ–≥–∞–º, –Ω–µ –ª—é–±–ª—é –∫–∞—Ä–¥–∏–æ, –ø—Ä–µ–¥–ø–æ—á–∏—Ç–∞—é —Å–≤–æ–±–æ–¥–Ω—ã–µ –≤–µ—Å–∞..."
                                          onchange="app.updateField('preferences', this.value)">${this.userData.preferences || ''}</textarea>
                                <p class="text-xs text-tg-hint mt-1">–ü–æ–º–æ–≥–∏—Ç–µ —Å–æ–∑–¥–∞—Ç—å –∏–¥–µ–∞–ª—å–Ω—É—é –ø—Ä–æ–≥—Ä–∞–º–º—É</p>
                            </div>
                        </div>
                    </div>
                `;
            }

            renderResult() {
                return `
                    <div class="fade-in">
                        <h2 class="text-lg font-semibold mb-4 text-green-600">üéâ –í–∞—à–∞ –ø—Ä–æ–≥—Ä–∞–º–º–∞ –≥–æ—Ç–æ–≤–∞!</h2>

                        <div class="mb-4 p-3 bg-green-50 rounded-lg border border-green-200">
                            <p class="text-sm text-green-700">
                                –ü—Ä–æ–≥—Ä–∞–º–º–∞ —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ –≤–∞—à–∏—Ö –¥–∞–Ω–Ω—ã—Ö!
                            </p>
                        </div>

                        <div id="program-content" class="bg-tg-secondary border border-tg-hint rounded-lg p-4 whitespace-pre-wrap text-sm max-h-96 overflow-y-auto mb-4 text-tg-text">
                            ${this.programContent || '–ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–æ–≥—Ä–∞–º–º—ã...'}
                        </div>

                        <div class="flex space-x-3">
                            <button onclick="app.startNew()"
                                    class="flex-1 py-3 tg-button text-white rounded-lg hover:opacity-90 transition flex items-center justify-center">
                                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                                </svg>
                                –ù–æ–≤–∞—è –ø—Ä–æ–≥—Ä–∞–º–º–∞
                            </button>
                            <button onclick="app.downloadProgram()"
                                    class="flex-1 py-3 bg-green-500 text-white rounded-lg hover:bg-green-600 transition flex items-center justify-center">
                                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                                </svg>
                                –°–∫–∞—á–∞—Ç—å
                            </button>
                        </div>

                        ${this.tg ? `
                            <div class="mt-4">
                                <button onclick="app.shareProgram()"
                                        class="w-full py-3 tg-secondary-bg text-tg-text rounded-lg hover:opacity-90 transition flex items-center justify-center">
                                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z" />
                                    </svg>
                                    –ü–æ–¥–µ–ª–∏—Ç—å—Å—è
                                </button>
                            </div>
                        ` : ''}
                    </div>
                `;
            }

            // –ú–µ—Ç–æ–¥—ã –≤—ã–±–æ—Ä–∞ –∑–Ω–∞—á–µ–Ω–∏–π
            selectGender(gender) {
                this.userData.gender = gender;
                this.updateMainButton();
                this.render();
            }

            selectGoal(goal) {
                this.userData.goal = goal;
                this.updateMainButton();
                this.render();
            }

            selectExperience(exp) {
                this.userData.last_trained = exp;
                this.updateMainButton();
                this.render();
            }

            selectWorkoutsPerWeek(num) {
                this.userData.workouts_per_week = num;
                this.updateMainButton();
                this.render();
            }

            selectWorkoutDuration(minutes) {
                this.userData.workout_duration = minutes;
                this.updateMainButton();
                this.render();
            }

            selectTrainingStyle(style) {
                this.userData.training_style = style;
                this.updateMainButton();
                this.render();
            }

            updateField(field, value) {
                this.userData[field] = value;
                this.updateMainButton();
            }

            attachEventListeners() {
                // –°–ª–∞–π–¥–µ—Ä –º–µ—Å—è—Ü–µ–≤
                const monthsSlider = document.getElementById('months');
                const monthsValue = document.getElementById('months-value');
                if (monthsSlider && monthsValue) {
                    monthsSlider.addEventListener('input', (e) => {
                        monthsValue.textContent = e.target.value;
                        this.userData.months = parseInt(e.target.value);
                    });
                }

                // –ê–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –ø–æ–ª–µ–π –≤–≤–æ–¥–∞
                const inputs = this.querySelectorAll('input, textarea, select');
                inputs.forEach(input => {
                    if (!input.onchange) {
                        input.addEventListener('change', (e) => {
                            const field = e.target.id;
                            const value = e.target.value;
                            this.updateField(field, value);
                        });
                    }
                });
            }

            validateCurrentStep() {
                switch(this.currentStep) {
                    case 1:
                        return this.userData.gender &&
                               this.userData.age &&
                               this.userData.height &&
                               this.userData.weight;
                    case 2:
                        if (!this.userData.goal) return false;
                        if (this.userData.goal === 'custom' && !this.userData.custom_goal) return false;
                        return this.userData.months && this.userData.months >= 1 && this.userData.months <= 12;
                    case 3:
                        return this.userData.current_results && this.userData.last_trained;
                    case 4:
                        return this.userData.workouts_per_week &&
                               this.userData.workout_duration &&
                               this.userData.training_style;
                    case 5:
                        return true; // –≠—Ç–∏ –ø–æ–ª—è –Ω–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã
                    default:
                        return true;
                }
            }

            getStepData() {
                const data = {};

                switch(this.currentStep) {
                    case 1:
                        data.gender = this.userData.gender;
                        data.age = parseInt(this.userData.age) || null;
                        data.height = parseInt(this.userData.height) || null;
                        data.weight = parseInt(this.userData.weight) || null;
                        break;
                    case 2:
                        data.goal = this.userData.goal;
                        data.custom_goal = this.userData.goal === 'custom' ? this.userData.custom_goal : '';
                        data.months = parseInt(this.userData.months) || 3;
                        break;
                    case 3:
                        data.current_results = this.userData.current_results || '';
                        data.last_trained = this.userData.last_trained;
                        break;
                    case 4:
                        data.workouts_per_week = parseInt(this.userData.workouts_per_week) || null;
                        data.workout_duration = parseInt(this.userData.workout_duration) || null;
                        data.training_style = this.userData.training_style;
                        break;
                    case 5:
                        data.health_restrictions = this.userData.health_restrictions || '';
                        data.preferences = this.userData.preferences || '';
                        break;
                }

                return data;
            }

            async nextStep() {
                if (!this.validateCurrentStep()) {
                    this.showError('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è');
                    return;
                }

                const stepData = this.getStepData();
                console.log(`Saving step ${this.currentStep}:`, stepData);

                const result = await this.saveStep(this.currentStep, stepData);
                if (!result) {
                    this.showError('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –¥–∞–Ω–Ω—ã–µ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.');
                    return;
                }

                if (this.currentStep < this.totalSteps) {
                    this.currentStep++;
                    this.render();
                } else if (this.currentStep === this.totalSteps) {
                    await this.generateAndShowProgram();
                }
            }

            async prevStep() {
                if (this.currentStep > 1) {
                    this.currentStep--;
                    this.render();
                }
            }

            async generateAndShowProgram() {
                console.log('Generating program...');
                const result = await this.generateProgram();

                if (result && result.content) {
                    this.programContent = result.content;
                    this.currentStep = 6;
                    this.render();

                    // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –∫–Ω–æ–ø–∫—É "–ü–æ–¥–µ–ª–∏—Ç—å—Å—è" –≤ Telegram
                    if (this.tg) {
                        this.setupShareButton();
                    }
                } else {
                    this.showError('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –ø—Ä–æ–≥—Ä–∞–º–º—É. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.');
                }
            }

            setupShareButton() {
                if (this.tg) {
                    this.tg.ShareButton.show();
                    this.tg.ShareButton.setParams({
                        text: '–ü–æ—Å–º–æ—Ç—Ä–∏—Ç–µ –º–æ—é –ø—Ä–æ–≥—Ä–∞–º–º—É —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫!',
                        url: window.location.href
                    });
                }
            }

            showError(message) {
                if (this.tg) {
                    this.tg.showAlert(message);
                } else {
                    alert(message);
                }
            }

            shareProgram() {
                if (this.tg && this.programContent) {
                    const shareText = `–ú–æ—è –ø—Ä–æ–≥—Ä–∞–º–º–∞ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫:\n\n${this.programContent.substring(0, 100)}...\n\n–°–æ–∑–¥–∞–Ω–æ –≤ @bullbads_event_bot`;
                    this.tg.openTelegramLink(`https://t.me/share/url?url=${encodeURIComponent(window.location.href)}&text=${encodeURIComponent(shareText)}`);
                }
            }

            startNew() {
                this.currentStep = 1;
                this.userData = {};
                this.programContent = null;
                this.sessionId = null;
                this.render();
                this.startSession();
            }

            downloadProgram() {
                if (!this.programContent) {
                    this.showError('–ù–µ—Ç –ø—Ä–æ–≥—Ä–∞–º–º—ã –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è');
                    return;
                }

                const blob = new Blob([this.programContent], { type: 'text/plain;charset=utf-8' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `–ø—Ä–æ–≥—Ä–∞–º–º–∞_—Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫_${new Date().toISOString().split('T')[0]}.txt`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }
        }

        // –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º –∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
        customElements.define('fitness-app', FitnessApp);

        // –ó–∞–ø—É—Å–∫ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        document.addEventListener('DOMContentLoaded', () => {
            console.log('DOM loaded, initializing app...');
            const app = new FitnessApp();
            document.getElementById('app').appendChild(app);
            window.app = app;

            // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–π —Ç–µ–º—ã Telegram
            if (window.Telegram?.WebApp) {
                window.Telegram.WebApp.onEvent('themeChanged', () => {
                    console.log('Theme changed, reapplying...');
                    window.app.applyTelegramTheme();
                });
            }
        });
    </script>
</body>
</html>